<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Home | Used Guitars and Broken Dreams</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <link href="static/css/style.css" rel="stylesheet">
  <script src="https://unpkg.com/vue@3" defer></script>
</head>
<body>
  <div id="home-app">
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand text-white" href="#"> <i class="bi bi-house-door-fill"></i> | Used Guitars and Broken Dreams</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav mr-auto">
          <li class="nav-item">
            <a class="nav-link text-white" href="#" @click.prevent="showAuctions"> <i class="bi bi-disc-fill"></i> Explore Auctions</a>
          </li>
          <li class="nav-item" v-if="isAuthenticated">
            <a class="nav-link text-white" href="#" @click.prevent="showUsers"> <i class="bi bi-people-fill"></i> Other Users</a>
          </li>
        </ul>
        <ul class="navbar-nav ms-auto">
          <li class="nav-item dropdown" v-if="!isAuthenticated">
            <a class="nav-link text-white dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Jump In!
            </a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
              <a class="dropdown-item" href="/login.html">Login</a>
              <a class="dropdown-item" href="/register.html">Register</a>              
            </div>
          </li>
          <li class="nav-item dropdown" v-if="isAuthenticated">
            <a class="nav-link text-white dropdown-toggle" href="#" id="navbarDropdown2" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="bi bi-person-circle"></i> {{ user ? `${user.name} ${user.surname}` : 'Loading...' }}
            </a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown2">
              <a class="dropdown-item" href="/login.html">Your Auctions</a>
              <a class="dropdown-item" href="/register.html">Your Bids</a>
            <div class="dropdown-divider"></div>
              <a class="dropdown-item" href="#" @click="logout">Logout</a>
            </div> 
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main content -->
  <div class="container mt-4" id="auctions-div" v-if="currentView === 'auctions'">
     <!-- Barra di ricerca -->
    <div class="row mb-3 align-items-center">
      <div class="col-md-6 d-flex">
        <input 
          type="text" 
          v-model="searchQuery" 
          class="form-control" 
          placeholder="Search for auctions..." 
          style="max-width: 300px;"
        />
        <button 
          class="btn btn-primary ms-2"
          @click="filterAuctions">
          <i class="bi bi-search"></i>
        </button>
      </div>
      <div class="col-md-6 text-end">
        <button 
          class="btn btn-success"
          @click="showCreateAuctionModal">
          <i class="bi bi-plus-circle"></i> Create Auction
        </button>
      </div>
    </div>

    <div class="row" id="auction-list">
      <div class="col-md-4 mb-4" v-for="auction in filteredAuctions" :key="auction.auction_id">
        <div class="card shadow-sm">
          <img :src="`images/${auction.auction_image || 'placeholder.png'}`" class="card-img-top" alt="Auction Image">
          <div class="card-body">
            <h5 class="card-title">{{ auction.auction_title }}</h5>
            <p class="card-text">{{ auction.auction_description }}</p>
            <p class="card-text">
              <strong>End Date: </strong> {{ formatDate(auction.end_date) }}
            </p>
            <p class="card-text">
              <strong>Status: </strong> 
              <span :class="auction.status === 'closed' ? 'text-danger' : 'text-success'">
                {{ isAuctionClosed(auction.status) }}
              </span>
            </p>
            <p class="card-text"><strong>Price: </strong> {{ auction.current_price }} </p>
            

            <div class="d-flex align-items-center mt-3" v-if="auction.user_image && auction.user_name">
              <img 
                :src="auction.user_image || 'images/default-user.jpg'" 
                alt="User Icon" 
                class="rounded-circle me-2" 
                style="width: 40px; height: 40px;"
              />
              <p class="mb-0">{{ auction.user_name }} {{ auction.user_surname }}</p>
            </div>
            <div class="d-flex justify-content-between mt-3" >
            <button v-if="isAuthenticated && user.id !== auction.auction_creator_id"
              :class="['btn', isAuthenticated ? 'btn-primary' : 'btn-secondary']"
              :disabled="!isAuthenticated || auction.status === 'closed' || user.id === auction.winner_id"
              
              @click="showCreateBidModal">
              Bid on it!
            </button>
            
            <button  v-if="auction"
              :disabled="!auction"
              class="ms-3"
              @click="showAuctionDetails(auction.auction_id)">
              Details
            </button>
          </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="container mt-4" id="users-div" v-if="currentView === 'users'">
    <!-- Barra di ricerca -->
   <div class="row mb-3 align-items-center">
     <div class="col-md-6 d-flex">
       <input 
         type="text" 
         v-model="searchQueryUsers" 
         class="form-control" 
         placeholder="Search for users..." 
         style="max-width: 300px;"
       />
       <button 
         class="btn btn-primary ms-2"
         @click="filterUsers">
         <i class="bi bi-search"></i>
       </button>
     </div>
   </div>

   <div class="row" id="users-list">
     <div class="col-md-4 mb-4" v-for="user in filteredUsers" :key="user.id">
       <div class="card shadow-sm">
         <img :src="`${user.image || 'images/default-user.jpg'}`" class="card-img-top" alt="User Image">
         <div class="card-body">
           <h5 class="card-title">{{ user.name }} {{ user.surname }}</h5>
           <p class="card-text">Username: {{ user.username }}</p>

           <button 
             :class="['btn', isAuthenticated ? 'btn-primary' : 'btn-secondary']"
             :disabled="!isAuthenticated"
             class="mt-3"
             @click="isAuthenticated && alert('Bid placed!')">
             User's auctions
           </button>
         </div>
       </div>
     </div>
   </div>
 </div>
 <div class="container mt-4" id="auctions-div" v-if="currentView === 'userAuctions'">
  <!-- Barra di ricerca -->
 <div class="row mb-3 align-items-center">
   <div class="col-md-6 d-flex">
     <input 
       type="text" 
       v-model="searchQuery" 
       class="form-control" 
       placeholder="Search for auctions..." 
       style="max-width: 300px;"
     />
     <button 
       class="btn btn-primary ms-2"
       @click="filterAuctions">
       <i class="bi bi-search"></i>
     </button>
   </div>
   <div class="col-md-6 text-end">
     <button 
       class="btn btn-success"
       @click="showCreateAuctionModal">
       <i class="bi bi-plus-circle"></i> Create Auction
     </button>
   </div>
 </div>

 <div class="row" id="user-auction-list">
   <div class="col-md-4 mb-4" v-for="auction in filteredUserAuctions" :key="auction.auction_id">
     <div class="card shadow-sm">
       <img :src="`images/${auction.auction_image || 'placeholder.png'}`" class="card-img-top" alt="Auction Image">
       <div class="card-body">
         <h5 class="card-title">{{ auction.auction_title }}</h5>
         <p class="card-text">{{ auction.auction_description }}</p>
         <p class="card-text">
           <strong>End Date: </strong> {{ formatDate(auction.end_date) }}
         </p>
         <p class="card-text">
           <strong>Status: </strong> 
           <span :class="auction.status === 'closed' ? 'text-danger' : 'text-success'">
             {{ isAuctionClosed(auction.status) }}
           </span>
         </p>
         <p class="card-text"><strong>Price: </strong> {{ auction.current_price }} </p>
         

         <div class="d-flex align-items-center mt-3">
           <img 
             :src="auction.user_image || 'images/default-user.jpg'" 
             alt="User Icon" 
             class="rounded-circle me-2" 
             style="width: 40px; height: 40px;"
           />
           <p class="mb-0">{{ auction.user_name }} {{ auction.user_surname }}</p>
         </div>

         <button v-if="user.id !== auction.auction_creator_id"
           :class="['btn', isAuthenticated ? 'btn-primary' : 'btn-secondary']"
           :disabled="!isAuthenticated || auction.status === 'closed' || user.id === auction.winner_id"
           class="mt-3"
           @click="isAuthenticated && alert('Bid placed!')">
           Bid on it! {{ user.id }}
         </button>
       </div>
     </div>
   </div>
 </div>
</div>

<div v-if="selectedAuction" class="container mt-4" id="auction-details-div" v-if="currentView === 'auction-details'">
  <div class="row">
      <div class="col-md-12">
          <button class="btn btn-secondary mb-3" @click="showAuctions">Back to Auctions</button>
          <h1>{{ selectedAuction.auction_title }}</h1>
          <img :src="`images/${selectedAuction.auction_image || 'placeholder.png'}`" alt="Auction Image" class="img-fluid mb-3" style="width: 300px; height: 200px;">
          <p><strong>Description:</strong> {{ selectedAuction.auction_description }}</p>
          <p><strong>End Date:</strong> {{ formatDate(selectedAuction.end_date) }}</p>
          <p><strong>Status: </strong> 
              <span :class="selectedAuction.status === 'closed' ? 'text-danger' : 'text-success'">
                  {{ isAuctionClosed(selectedAuction.status) }}
              </span>
          </p>
          <p><strong>Current Price:</strong> {{ selectedAuction.current_price }}</p>
          <div class="d-flex align-items-center mt-3 mb-3" v-if="selectedAuction.winner_name">
            <img 
              :src="selectedAuction.winner_image || 'images/default-user.jpg'" 
              alt="User Icon" 
              class="rounded-circle me-2" 
              style="width: 40px; height: 40px;"
            />
            <p class="mb-0"><strong>Winning User:</strong> {{ selectedAuction.winner_name }} {{ selectedAuction.winner_surname }}</p>
          </div>
          <h3>Bids</h3>
          <ul>
              <li v-for="bid in auctionBids" :key="bid.bid_id">
                  {{ bid.bidder_name }} bid {{ bid.bid_amount }} on {{ formatDate(bid.bid_created_at) }}
              </li>
          </ul>
          <div v-if="isAuthenticated && selectedAuction.status !== 'closed'">
              <input type="number" v-model="newBidAmount" placeholder="Your bid" class="form-control mb-2">
              <button class="btn btn-primary" @click="placeBid">Place Bid</button>
          </div>
      </div>
  </div>
</div>
<div v-else>
  <p>Loading auction details...</p>
</div>


<div class="modal fade" id="createAuctionModal" tabindex="-1" aria-labelledby="createAuctionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createAuctionModalLabel">Create New Auction</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form @submit.prevent="createAuction">
          <div class="mb-3">
            <label for="auctionTitle" class="form-label">Title</label>
            <input type="text" v-model="newAuction.title" class="form-control" id="auctionTitle" required>
          </div>
          <div class="mb-3">
            <label for="auctionDescription" class="form-label">Description</label>
            <textarea v-model="newAuction.description" class="form-control" id="auctionDescription" rows="3" required></textarea>
          </div>
          <div class="mb-3">
            <label for="auctionStartPrice" class="form-label">Start Price</label>
            <input type="number" v-model="newAuction.start_price" class="form-control" id="auctionStartPrice" required>
          </div>
          <div class="mb-3">
            <label for="auctionEndDate" class="form-label">End Date</label>
            <input type="datetime-local" v-model="newAuction.end_date" class="form-control" id="auctionEndDate" required>
          </div>
          <div class="mb-3">
            <label for="auctionImage" class="form-label">Upload Image</label>
            <input 
              type="file" 
              class="form-control" 
              id="auctionImage" 
              @change="handleFileUpload" 
              name="image" 
              accept="image/*">
          </div>          
          <button type="submit" class="btn btn-primary">Create</button>
        </form>
      </div>
    </div>
  </div>
</div>
</div>
  <footer class="text-center py-3">
    <p>Used Guitars and Broken Dreams.</p>
  </footer>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="static/js/home.js"  type="module" defer></script>
</body>

</html>
